name: Build Flatpak (Reusable)

on:
  workflow_call:
    inputs:
      build-tests:
        description: 'Build with tests enabled (not used by Flatpak)'
        required: false
        type: boolean
        default: true
      is-release:
        description: 'Mark as release build'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version string (for release builds)'
        required: false
        type: string
        default: 'dev'
    outputs:
      artifact-name:
        description: "Name of the build/package artifact"
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:kde-6.8
      options: --privileged
    outputs:
      artifact-name: ${{ steps.artifact-name.outputs.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Set bundle name
        id: bundle-name
        run: |
          if [ "${{ inputs.is-release }}" = "true" ]; then
            echo "bundle=decode-orc-${{ inputs.version }}.flatpak" >> $GITHUB_OUTPUT
          else
            echo "bundle=decode-orc.flatpak" >> $GITHUB_OUTPUT
          fi
      
      - name: Prepare Flatpak manifest for release
        if: inputs.is-release
        run: |
          python3 << 'EOF'
          import yaml
          
          with open('io.github.simoninns.decode-orc.yml', 'r') as f:
              manifest = yaml.safe_load(f)
          
          # Find the decode-orc module and add the version config
          for module in manifest.get('modules', []):
              if module.get('name') == 'decode-orc':
                  if 'config-opts' not in module:
                      module['config-opts'] = []
                  module['config-opts'].append('-DPROJECT_VERSION_OVERRIDE=${{ inputs.version }}')
                  break
          
          with open('io.github.simoninns.decode-orc-release.yml', 'w') as f:
              yaml.dump(manifest, f, default_flow_style=False, sort_keys=False)
          
          print("Created release manifest with version override")
          EOF
          
          echo "MANIFEST_FILE=io.github.simoninns.decode-orc-release.yml" >> $GITHUB_ENV
      
      - name: Set manifest for non-release
        if: ${{ !inputs.is-release }}
        run: echo "MANIFEST_FILE=io.github.simoninns.decode-orc.yml" >> $GITHUB_ENV
      
      - name: Pre-download external dependencies with retries
        run: |
          # Create download helper function
          download_with_retry() {
            local url="$1"
            local filename="$2"
            local max_attempts=3
            local retry_delay=5
            
            echo "Downloading: $filename from $url"
            
            for attempt in $(seq 1 $max_attempts); do
              echo "  Attempt $attempt of $max_attempts..."
              if curl -f -L -o "$filename" "$url"; then
                echo "  ✓ Downloaded successfully"
                return 0
              fi
              
              if [ $attempt -lt $max_attempts ]; then
                echo "  ✗ Download failed, waiting ${retry_delay}s before retry..."
                sleep $retry_delay
              fi
            done
            
            echo "  ✗ Failed after $max_attempts attempts"
            return 1
          }
          
          # Pre-download all external dependencies
          download_with_retry "https://www.fftw.org/fftw-3.3.10.tar.gz" "fftw-3.3.10.tar.gz"
          download_with_retry "https://bitbucket.org/multicoreware/x265_git/downloads/x265_3.6.tar.gz" "x265_3.6.tar.gz"
          download_with_retry "https://www.nasm.us/pub/nasm/releasebuilds/2.16.03/nasm-2.16.03.tar.xz" "nasm-2.16.03.tar.xz"
          download_with_retry "https://ffmpeg.org/releases/ffmpeg-7.1.tar.xz" "ffmpeg-7.1.tar.xz"
          
          echo ""
          echo "All external dependencies pre-downloaded successfully"
      
      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: ${{ steps.bundle-name.outputs.bundle }}
          manifest-path: ${{ env.MANIFEST_FILE }}
          cache-key: flatpak-builder-${{ github.sha }}
          upload-artifact: false
      
      - name: Set artifact name
        id: artifact-name
        run: |
          if [ "${{ inputs.is-release }}" = "true" ]; then
            echo "name=flatpak-bundle" >> $GITHUB_OUTPUT
          else
            echo "name=build-flatpak" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: decode-orc*.flatpak
          retention-days: ${{ inputs.is-release && 7 || 1 }}
