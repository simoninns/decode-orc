name: Build Flatpak (Reusable)

on:
  workflow_call:
    inputs:
      build-tests:
        description: 'Build with tests enabled (not used by Flatpak)'
        required: false
        type: boolean
        default: true
      is-release:
        description: 'Mark as release build'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version string (for release builds)'
        required: false
        type: string
        default: 'dev'
    outputs:
      artifact-name:
        description: "Name of the build/package artifact"
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build Flatpak
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact-name.outputs.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Install flatpak and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            flatpak \
            flatpak-builder \
            appstream
      
      - name: Add Flathub repository
        run: flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
      
      - name: Install Flatpak runtime and SDK
        run: |
          flatpak install --user -y flathub org.kde.Platform/x86_64/6.8
          flatpak install --user -y flathub org.kde.Sdk/x86_64/6.8
      
      - name: Build Flatpak with flatpak-builder
        run: |
          flatpak-builder \
            --user \
            --repo=repo \
            --disable-rofiles-fuse \
            --install-deps-from=flathub \
            --force-clean \
            --default-branch=master \
            --arch=x86_64 \
            flatpak_app \
            io.github.simoninns.decode-orc.yml
      
      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle \
            --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo \
            repo \
            decode-orc-${{ inputs.version }}.flatpak \
            io.github.simoninns.decode-orc
      
      - name: Set artifact name
        id: artifact-name
        run: |
          if [ "${{ inputs.is-release }}" = "true" ]; then
            echo "name=flatpak-bundle" >> $GITHUB_OUTPUT
          else
            echo "name=build-flatpak" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: decode-orc-*.flatpak
          retention-days: ${{ inputs.is-release && 7 || 1 }}
