name: Build macOS (Reusable)

on:
  workflow_call:
    inputs:
      build-tests:
        description: 'Build with tests enabled'
        required: false
        type: boolean
        default: true
      is-release:
        description: 'Mark as release build'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version string (for release builds)'
        required: false
        type: string
        default: 'dev'
    outputs:
      artifact-name:
        description: "Name of the build/package artifact"
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build macOS
    runs-on: macos-latest
    outputs:
      artifact-name: ${{ steps.artifact-name.outputs.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Clean up any existing Nix installation
        run: |
          # Clean up any leftover Nix installation state
          set +e
          
          # Kill any running Nix processes
          sudo pkill -f nix-daemon 2>/dev/null || true
          pkill -f nix 2>/dev/null || true
          sleep 2
          
          # Remove Nix directories and volumes
          sudo rm -rf /nix 2>/dev/null || true
          sudo rm -rf /var/root/.nix-profile 2>/dev/null || true
          sudo rm -rf /etc/nix 2>/dev/null || true
          
          # Remove synthetic.conf entries for Nix
          sudo sed -i '' '/^nix/d' /etc/synthetic.conf 2>/dev/null || true
          
          # Remove fstab entries for Nix
          sudo sed -i '' '/nix/d' /etc/fstab 2>/dev/null || true
          
          # Remove LaunchDaemons related to Nix
          sudo rm -f /Library/LaunchDaemons/com.apple.nix-daemon.plist 2>/dev/null || true
          sudo rm -f /Library/LaunchDaemons/org.nixos.nix-daemon.plist 2>/dev/null || true
          
          # Remove Nix build users and group - be more aggressive
          if command -v dscl &> /dev/null; then
            # Delete all build users
            for i in {1..10}; do
              # Use different deletion methods to ensure cleanup
              sudo dscl . -delete "/Users/_nixbld$i" >/dev/null 2>&1 || true
              # Also try via DSLocalDB path
              sudo dscl /Local/Default -delete "/Users/_nixbld$i" >/dev/null 2>&1 || true
            done
            # Delete build group
            sudo dscl . -delete "/Groups/nixbld" >/dev/null 2>&1 || true
            sudo dscl /Local/Default -delete "/Groups/nixbld" >/dev/null 2>&1 || true
          fi
          
          # Verify users are gone and show what users exist
          echo "Remaining users matching _nixbld pattern:"
          dscl . list /Users | grep _nixbld || echo "None found (good!)"
          
          set -e
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Install create-dmg (for packaging)
        run: brew install create-dmg
      
      - name: Build with Nix
        run: nix build --cores 0 --print-build-logs
      
      - name: Create DMG
        run: |
          DMG_NAME="decode-orc-${{ inputs.version }}.dmg"
          
          # Nix builds don't create .app bundles with GUI, so create a simple DMG with binaries
          mkdir -p dmg-contents
          cp -r result/bin/* dmg-contents/
          
          create-dmg \
            --volname "Decode Orc" \
            --window-size 500 320 \
            "$DMG_NAME" \
            "dmg-contents"
          
          echo "Created DMG: $DMG_NAME"
          ls -lh "$DMG_NAME"
      
      - name: Set artifact name
        id: artifact-name
        run: |
          if [ "${{ inputs.is-release }}" = "true" ]; then
            echo "name=macos-dmg" >> $GITHUB_OUTPUT
          else
            echo "name=build-macos" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: decode-orc-*.dmg
          retention-days: ${{ inputs.is-release && 7 || 1 }}
