name: Build Windows (Reusable)

on:
  workflow_call:
    inputs:
      build-tests:
        description: 'Build with tests enabled'
        required: false
        type: boolean
        default: true
      is-release:
        description: 'Mark as release build'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version string (for release builds)'
        required: false
        type: string
        default: 'dev'
    outputs:
      artifact-name:
        description: "Name of the build/package artifact"
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    name: Build Windows
    runs-on: windows-latest
    outputs:
      artifact-name: ${{ steps.artifact-name.outputs.name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      
      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          cache: true
      
      - name: Setup vcpkg binary cache
        uses: actions/cache@v4
        with:
          path: C:/vcpkg/archives
          key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-binary-${{ runner.os }}-
      
      - name: Cache FFmpeg
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: C:/ffmpeg
          key: ffmpeg-btbn-latest-win64-gpl-shared
      
      - name: Install FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
          $ffmpegZip = "$env:TEMP\ffmpeg.zip"
          $ffmpegDir = "C:\ffmpeg"
          
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip
          Expand-Archive -Path $ffmpegZip -DestinationPath $ffmpegDir -Force
        shell: pwsh
      
      - name: Setup FFmpeg environment
        run: |
          $extractedDir = Get-ChildItem -Path "C:\ffmpeg" -Directory | Select-Object -First 1
          $ffmpegRoot = $extractedDir.FullName
          echo "$ffmpegRoot\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "FFMPEG_ROOT=$ffmpegRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh
      
      - name: Install vcpkg dependencies
        run: |
          vcpkg install --triplet x64-windows
      
      - name: Configure
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_GUI=ON `
            -DBUILD_TESTS=${{ inputs.build-tests && 'ON' || 'OFF' }} `
            -DCMAKE_PREFIX_PATH="${env:Qt6_DIR};$env:FFMPEG_ROOT" `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        shell: pwsh
      
      - name: Build
        run: cmake --build build --config Release --parallel
      
      - name: Verify binaries
        run: |
          if (Test-Path "build/bin/Release/orc-cli.exe") {
            Write-Host "✓ orc-cli built successfully"
          } else {
            Write-Host "✗ orc-cli not found" -ForegroundColor Red
            exit 1
          }
          if (Test-Path "build/bin/Release/orc-gui.exe") {
            Write-Host "✓ orc-gui built successfully"
          } else {
            Write-Host "✗ orc-gui not found" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
      
      - name: Install WiX Toolset (release only)
        if: inputs.is-release
        run: |
          choco install wixtoolset -y
          
          # Find WiX installation directory
          $wixPath = Get-ChildItem "C:\Program Files (x86)" -Filter "WiX Toolset*" -Directory | Select-Object -First 1 -ExpandProperty FullName
          if (-not $wixPath) {
            $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14"
          }
          $wixBin = Join-Path $wixPath "bin"
          
          Write-Host "WiX Toolset found at: $wixBin"
          echo "$wixBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          if (Test-Path (Join-Path $wixBin "candle.exe")) {
            Write-Host "✓ candle.exe found"
          } else {
            Write-Host "ERROR: candle.exe not found in $wixBin" -ForegroundColor Red
            exit 1
          }
      
      - name: Create RTF license (release only)
        if: inputs.is-release
        run: |
          $licenseContent = Get-Content -Path "LICENSE" -Raw
          $rtfHeader = "{\rtf1\ansi\deff0 {\fonttbl {\f0 Courier New;}}\f0\fs18"
          $rtfFooter = "}"
          $licenseRtf = $licenseContent -replace '\\', '\\\\' -replace '{', '\{' -replace '}', '\}' -replace "`n", "\par`n"
          $fullRtf = $rtfHeader + "`n" + $licenseRtf + "`n" + $rtfFooter
          $fullRtf | Out-File -FilePath "build/LICENSE.rtf" -Encoding ASCII
          Write-Host "Created LICENSE.rtf for WiX installer"
      
      - name: Generate MSI installer (release only)
        if: inputs.is-release
        run: |
          cd build
          cpack -C Release -G WIX --verbose 2>&1 | Tee-Object -FilePath cpack-output.log
          $CPACK_RESULT = $LASTEXITCODE
          
          if ($CPACK_RESULT -ne 0) {
            Write-Host "`nCPack failed. Checking for WiX log..." -ForegroundColor Red
            $logPath = "_CPack_Packages/win64/WIX/wix.log"
            if (Test-Path $logPath) {
              Write-Host "`nWiX Log Contents:" -ForegroundColor Yellow
              Get-Content $logPath
            }
            exit 1
          }
          
          Write-Host "`nGenerated installer packages:"
          Get-ChildItem -Filter "*.msi"
      
      - name: Set artifact name
        id: artifact-name
        shell: bash
        run: |
          if [ "${{ inputs.is-release }}" = "true" ]; then
            echo "name=windows-installer" >> $GITHUB_OUTPUT
          else
            echo "name=build-windows" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: |
            ${{ inputs.is-release && 'build/*.msi' || 'build/bin/' }}
            build/lib/
            build/generated/
            build/CMakeCache.txt
            build/CPackConfig.cmake
            build/CPackSourceConfig.cmake
          retention-days: ${{ inputs.is-release && 7 || 1 }}
