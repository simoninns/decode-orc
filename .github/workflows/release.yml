name: Release Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

jobs:
  # Windows MSI Build
  build-windows-msi:
    name: Build Windows ZIP
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.8.1'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          cache: true
      
      - name: Setup vcpkg binary cache
        uses: actions/cache@v4
        with:
          path: |
            C:/vcpkg/installed
            C:/vcpkg/packages
            C:/Users/runneradmin/AppData/Local/vcpkg/archives
          key: vcpkg-release-${{ runner.os }}-${{ hashFiles('**/vcpkg.json') }}-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            vcpkg-release-${{ runner.os }}-
      
      - name: Install vcpkg dependencies
        run: |
          vcpkg install --triplet x64-windows `
            spdlog `
            sqlite3 `
            yaml-cpp `
            libpng `
            fftw3 `
            pkgconf
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: Configure CMake
        run: |
          cd build
          cmake .. `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_GUI=ON `
            -DBUILD_TESTS=OFF `
            -DCMAKE_PREFIX_PATH="${env:Qt6_DIR}" `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
      
      - name: Build
        run: |
          cd build
          cmake --build . --config Release -j $env:NUMBER_OF_PROCESSORS
      
      - name: Install to staging directory
        run: |
          cd build
          cmake --install . --config Release --prefix install
      
      - name: Deploy Qt dependencies
        run: |
          cd build/install/bin
          & "$env:QT_ROOT_DIR/bin/windeployqt.exe" --release --no-translations orc-gui.exe
      
      - name: Copy vcpkg runtime dependencies
        run: |
          $vcpkgRoot = "C:/vcpkg/installed/x64-windows"
          $binDir = "build/install/bin"
          
          # Copy DLL files - get specific required DLLs
          $dlls = @(
            "fftw3.dll",
            "fftw3f.dll", 
            "fftw3l.dll",
            "spdlog.dll",
            "yaml-cpp.dll",
            "fmt.dll",
            "libpng16.dll",
            "zlib1.dll",
            "sqlite3.dll"
          )
          
          foreach ($dll in $dlls) {
            $sourcePath = Join-Path "$vcpkgRoot/bin" $dll
            if (Test-Path $sourcePath) {
              Copy-Item $sourcePath $binDir -Force
              Write-Host "Copied $dll"
            }
          }
          
          Write-Host "Copied vcpkg runtime dependencies"
      
      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create portable ZIP package
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          
          # Create a clean directory for the package
          New-Item -ItemType Directory -Path "decode-orc-portable" -Force
          
          # Copy all files from install/bin
          Copy-Item -Path "build/install/bin/*" -Destination "decode-orc-portable/" -Recurse -Force
          
          # Create a README
          @"
          Decode ORC v$version - Portable Windows Build
          
          This is a portable build of Decode ORC for Windows.
          
          To run the GUI application: Double-click orc-gui.exe
          To run the CLI application: Run orc-cli.exe from command prompt
          
          All required DLLs and Qt dependencies are included in this package.
          "@ | Out-File -FilePath "decode-orc-portable/README.txt" -Encoding UTF8
          
          # Create ZIP archive
          Compress-Archive -Path "decode-orc-portable/*" -DestinationPath "decode-orc-$version-windows-x64.zip" -Force
          
          Write-Host "Created portable package: decode-orc-$version-windows-x64.zip"
      
      - name: Upload Windows ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: decode-orc-${{ steps.get_version.outputs.version }}-windows-x64.zip
          retention-days: 7

  # macOS DMG Build
  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Install system dependencies
        run: |
          brew update || true
          brew install \
            cmake \
            pkg-config \
            spdlog \
            sqlite \
            yaml-cpp \
            libpng \
            fftw \
            qt@6 \
            create-dmg
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: Configure CMake
        run: |
          cd build
          export HOMEBREW_PREFIX=$(brew --prefix)
          export Qt6_DIR=$HOMEBREW_PREFIX/opt/qt@6/lib/cmake/Qt6
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_GUI=ON \
            -DBUILD_TESTS=OFF \
            -DCMAKE_PREFIX_PATH="$HOMEBREW_PREFIX" \
            -DQt6_DIR=$Qt6_DIR \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0
      
      - name: Build
        run: |
          cd build
          cmake --build . -j$(sysctl -n hw.ncpu)
      
      - name: Create app bundle
        run: |
          mkdir -p "Decode ORC.app/Contents/MacOS"
          mkdir -p "Decode ORC.app/Contents/Resources"
          
          # Copy executables
          cp build/bin/orc-gui "Decode ORC.app/Contents/MacOS/"
          cp build/bin/orc-cli "Decode ORC.app/Contents/MacOS/"
          
          # Copy icon if available
          if [ -f "assets/orc-gui-icon.icns" ]; then
            cp assets/orc-gui-icon.icns "Decode ORC.app/Contents/Resources/"
          fi
          
          # Create PkgInfo
          echo "APPL????" > "Decode ORC.app/Contents/PkgInfo"
          
          # Create Info.plist
          cat > "Decode ORC.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>orc-gui</string>
            <key>CFBundleIdentifier</key>
            <string>io.github.simoninns.decode-orc</string>
            <key>CFBundleName</key>
            <string>Decode ORC</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleIconFile</key>
            <string>orc-gui-icon</string>
            <key>LSMinimumSystemVersion</key>
            <string>11.0</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>NSPrincipalClass</key>
            <string>NSApplication</string>
          </dict>
          </plist>
          EOF
      
      - name: Deploy Qt dependencies
        run: |
          HOMEBREW_PREFIX=$(brew --prefix)
          $HOMEBREW_PREFIX/opt/qt@6/bin/macdeployqt "Decode ORC.app" -verbose=2
      
      - name: Code sign app bundle (ad-hoc)
        run: |
          # Ad-hoc signing - allows the app to run but users will need to right-click > Open first time
          # This prevents the "app is damaged" error
          codesign --force --deep --sign - "Decode ORC.app"
          
          # Verify the signature
          codesign --verify --verbose=2 "Decode ORC.app"
      
      - name: Create CLI symlink installer script
        run: |
          cat > "Install CLI Tool.command" << 'EOF'
          #!/bin/bash
          # This script creates a symlink to orc-cli in /usr/local/bin
          # so it can be run from anywhere in the terminal
          
          echo "Installing orc-cli to /usr/local/bin..."
          
          # Find the app bundle location
          APP_PATH="/Applications/Decode ORC.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "Error: Decode ORC.app not found in /Applications"
            echo "Please drag the app to /Applications first, then run this script again."
            read -p "Press Enter to exit..."
            exit 1
          fi
          
          # Create /usr/local/bin if it doesn't exist
          sudo mkdir -p /usr/local/bin
          
          # Remove old symlink if it exists
          if [ -L /usr/local/bin/orc-cli ]; then
            sudo rm /usr/local/bin/orc-cli
          fi
          
          # Create the symlink
          sudo ln -s "$APP_PATH/Contents/MacOS/orc-cli" /usr/local/bin/orc-cli
          
          if [ $? -eq 0 ]; then
            echo "✓ Successfully installed orc-cli!"
            echo "You can now run 'orc-cli' from anywhere in the terminal."
          else
            echo "✗ Failed to install orc-cli"
            exit 1
          fi
          
          read -p "Press Enter to exit..."
          EOF
          
          chmod +x "Install CLI Tool.command"
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create DMG staging directory
        run: |
          mkdir -p dmg-staging
          cp -R "Decode ORC.app" dmg-staging/
          cp "Install CLI Tool.command" dmg-staging/
          
          # Create a README
          cat > "dmg-staging/README.txt" << 'EOF'
          Decode ORC - Installation Instructions
          ========================================
          
          1. Drag "Decode ORC" to your Applications folder
          
          2. To launch the GUI:
             - Right-click "Decode ORC" in Applications and select "Open"
             - Click "Open" in the security dialog
             - After first launch, you can double-click normally
          
          3. To install the CLI tool (optional):
             - Double-click "Install CLI Tool" in this DMG
             - Enter your password when prompted
             - You can then run "orc-cli" from any terminal
          
          EOF
      
      - name: Create DMG
        run: |
          create-dmg \
            --volname "Decode ORC" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "decode-orc-${{ steps.get_version.outputs.version }}-macOS.dmg" \
            "dmg-staging" || true
          
          # Fallback if create-dmg fails
          if [ ! -f "decode-orc-${{ steps.get_version.outputs.version }}-macOS.dmg" ]; then
            hdiutil create -volname "Decode ORC" -srcfolder "dmg-staging" -ov -format UDZO "decode-orc-${{ steps.get_version.outputs.version }}-macOS.dmg"
          fi
      
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: decode-orc-${{ steps.get_version.outputs.version }}-macOS.dmg
          retention-days: 7

  # Flatpak Build
  build-flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:kde-6.8
      options: --privileged
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: decode-orc-${{ steps.get_version.outputs.version }}.flatpak
          manifest-path: io.github.simoninns.decode-orc.yml
          cache-key: flatpak-builder-release-${{ github.sha }}
      
      - name: Upload Flatpak bundle
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: decode-orc-${{ steps.get_version.outputs.version }}.flatpak
          retention-days: 7

  # Create GitHub Release and Upload Assets
  create-release:
    name: Create GitHub Release
    needs: [build-windows-msi, build-macos-dmg, build-flatpak]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Display structure of downloaded files
        run: ls -R release-artifacts
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-artifacts/windows-zip/*.zip
            release-artifacts/macos-dmg/*.dmg
            release-artifacts/flatpak-bundle/*.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
